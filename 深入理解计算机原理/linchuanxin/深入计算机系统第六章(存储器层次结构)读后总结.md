- 存储器系统（memory system)是一个具有不同容量、成本和访问时间的存储设备的层次结构。CPU 寄存器保存着最常用的数据。
- 靠近 CPU 的小的、快速的高 速缓存存储器（cache memory)作为一部分存储在相对慢速的主存储器（main memory)中数据和指令的缓冲区域。
- 主存缓存存储在容量较大的、慢速磁盘上的数据，而这些磁盘常常又作为存储在通过网络连接的其他机器的磁盘或磁带上的数据的缓冲区域



6.1. 1  随机访问存储器

随机访问存储器（Random-Access Memory, RAM)分为两类：**静态的**和**动态的**。

静态特点：

- 静态RAM(SRAM)比动态 RAM(DRAM)更快

- DRAM 用来作为主存以及图形系统的帧缓冲区

- 一个桌面系统的 SRAM 不会超过几兆字节，但是 DRAM 却有几百或几千兆字节

- SRAM 将每个位存储在一个双稳态的（bistable)存储器单元里。每个单元是用一个六晶体管电路来实现的

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-1.png)

说明：

1. 当钟摆倾斜到最左边或最右边时，它是稳定的
2. 由于 SRAM 存储器单元的双稳态特性，只要有电，它就会永远地保持它的值。即使有干扰（例如电子噪音)来扰乱电压，当干扰消除时，电路就会恢复到稳定值。

动态特点：

- DRAM 将每个位存储为对一个电容的充电

- 电容非常小，通常只有大约 30 毫微微法拉(femtofarad)—— 30X10^-15法拉

- DRAM 存储器单元对干扰非常敏感

- 当电容的电压被扰乱之后，它就永远不会恢复了

  

  **DRAM 和 SRAM 存储器的特性**

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-2.png)

6.2  局部性

倾向于引用邻近于其他最近引用过的数据项的数据项，或者最近引用过的数据项本身。这种倾向

性，被称为局部性原理（principle of locality)

有两种不同的形式：

1. 时间局部性
2. 和空间局部性

6.2.3 局部性原则

量化评价程序中局部性的一些简单原则：

- 重复引用相同变量的程序有良好的时间局部性

- 对于具有步长为k的引用模式的程序，步长越小，空间局部性越好。具有步长为 l模式的程序有

  很好的空间局部性。在内存中以大步长跳来跳去的程序空间局部性会很差

- 对于取指令来说，循环有好的时间和空间局部性。循环体越小，循环迭代次数越多，局部性

  越好



6.3 **存储器层次结构**

计算机软件的一些基本的和持久的属性：

1. **存储技术**：不同存储技术的访问时间差异很大。速度较快的技术每字节的成本要比速度较慢的技术高，而且容量较小。CPU 和主存之间的速度差距在增大
2. **计算机软件**：一个编写良好的程序倾向于展示出良好的局部性

**存储器层次结构图*

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-21.png)

6.3.1 存储器层次结构中的缓存

**高速缓存** 是一个小而快速的存储设备，它作为存储在更大、也更慢的设备中的数据对象的缓冲区域。使用高速缓存的过程称为**缓存**

存储器层次结构的中心思想是，对于每个k，位于k层的更快更小的存储设备作为位于k+1层的更大更慢的存储设备的缓存。换句话说，层次结构中的每一层都缓存来自较低一层的数据对象

例如，本地磁盘作为通过网络从远程磁盘取出的文件（例如 Web 页面）的缓存，主存作为本地磁盘上数据的缓存，依此类推，黨到最小的缓存棗 CPU 寄存器组

**缓存概念**：

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-22.png)

第k+1 层的存储器被划分成连续的数据对象组块（chunk), 称为块（block)。每个块都有一个唯一的地址或名字，使之区别于其他的块。块可以是固定大小的（通常是这样的）， 也可以是可变大小的（例如存储在Web 服务器上的远程 HTML 文件）

- 第k层的存储器被划分成较少的块的集合，每个块的大小与k+1 层的块的大小一样。在任何时刻，第k层的缓存包含第k+1 层块的一个子集的副本
- 数据总是以块大小为传送单元在第k层和第k +1 层之间来回复制的。虽然在层次结构中任何一对相邻的层次之间块大小是固定的，但是其他的层次对之间可以有不同的块大小。



**层次结构中较低层(离 CPU 较远）的设备的访问时间较长，因此为了补偿这些较长的访问时间，倾向于使用较大的块**

如下：

- 缓存命中
- 缓存不命中：如果第k层中没有缓存数据对象 那么就是我 们所说的缓存不命中
- 缓存不命中的种类
  - 一个空的缓存有时被称为冷缓存, 此类不命中称为强制性不命中或冷不命中
- 缓存管理



6.3.2  存储器层次结构概念小结

1. 利 用时间局部性：由于时间局部性，同一数据对象可能会被多次使用。一旦一个数据对象在第一次不命中时被复制到缓存中，我们就会期望后面对该目标有一系列的访问命中

2. 利用空间局部性：块通常包含有多个数据对象。由于空间局部性，我们会期望后面对该块中其他对象的访问能够补偿不命中后复制该块的花费

   ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-23.png)

6.4 **高速缓存存储器**

早期计算机系统的存储器层次结构只有三层：CPU 寄存器、DRAM 主存储器和磁盘存储。不过，由于 CPU 和主存之间逐渐增大的差距，系统设计者被迫在 CPU 寄存器文件和主存之间插入了一个小的SRAM 高 速缓存存储器，称为 L1 高 速缓存（一级缓存）

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-24.png)

**随着 CPU 和主存之间的性能差距不断增大，系统设计者在 L1 高速缓存和主存之间又插入了一个更大的高速缓存，称为 L2 高速缓存，可以在大约 10 个时钟周期内访问到它。有些现代系统还包括有一个更大的高速缓存，称为 L3 高速缓存，在存储器层次结构中，它位于 L2 高速缓存和主存之间，可以在大约 50 个周期内访问到它**



6.4. 1 通用的高速缓存存储器组织结构

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-25.png)

说明：

- 每个存储器地址有m位，形成 M=2^m个不同的地址

- 高速缓存被组织成一个有 S=2^s个高速缓存组的数组,每个组包含 E个高速缓存行,每个行是由一个 B =2^b 字节的数据块组成的

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-26.png)

6.4.2 直接映射高速缓存

据每个组的高速缓存行数E,高速缓存被分为不同的类。每个组只有一行(E=1)的高速缓存称为直接映射高速缓存

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-27.png)

高速缓存确定一个请求**是否命中**，然后抽取出被请求的字的过程,分为三步：

1) 组 选择

2)行匹配

3) 字抽取

- 直接映射高速缓存中的组选择

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-28.png)

- 直接映射高速缓存中的行匹配

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-29.png)

- 直接映射高速缓存中的字选择

- 直接映射高速缓存中不命中时的行替换

-  综合：运行中的直接映射高速缓存

4位地址空间

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-30.png)



- 标记位和索引位连起来唯一地标识了内存中的每个块
- 因为有 8 个内存块，但是只有 4 个高速缓存组，所以多个块会映射到同一个高速缓存组（即它们有相同的组索引）
- 映射到同一个高速缓存组的块由标记位唯一地标识

6.4.3 组相联高速缓存

 2路组相联高速缓存的结构：

![](G:\luge_100\minegithub\BookSummary\深入计算机系统\image\6-32.png)

- 组相联高速缓存中的组选择

- 组相联高速缓存中的行匹配和字选择

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-33.png)

  ![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-34.png)

- 组相联高速缓存中不命中时的行替换

6.4.6 1个真实的高速缓存层次结构的解剖

**Intel Core i7 处理器的高速缓存层次结构**：

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-38.png)

结构特性：

![](https://gitee.com/andylinchuanxin/bookimagehome/raw/master/img/6-39.png)

6.4.7 高速缓存参数的性能影响

**衡量高速缓存的性能**：

1. 不命中率
2. 命中率
3. 命中时间
4. 不命中处罚

**优化高速缓存**:

1. 高速缓存大小的影响
2. 块大小的影响
3. 相联度的影响
4. 写策略的影响

6.5 **编写高速缓存友好的代码**

友好的代码的重要问题:

- 对局部变量的反复引用是好的，因为编译器能够将它们缓存在寄存器文件中（时间局部性）
- 步长为 1 的引用模式是好的，因为存储器层次结构中所有层次上的缓存都是将数据存储为连续的块（空间局部性）

6.6  综合：高速缓存对程序性能的影响

6.6.1  存储器山:

一个程序从存储系统中读数据的速率称为读呑吐量 或者有时称为读带宽