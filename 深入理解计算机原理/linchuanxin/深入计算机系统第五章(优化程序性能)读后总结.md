编写高效程序需要做到以下：

第一，我们必须选择一组适当的算法和数据结构。

第二，我们必须编写出编译器能够有效优化以转换成高效可执行代码的源代码。

5.2  程序性能

- 周期数（Cycles Per Element, CPE), 作为一种表示程序性能并指导我们改进代码的方法。
- 一个系统有“4GHz”处理器，这表示处理器时钟运行频率为每秒4X109个周期。每个时钟周期的时间是时钟频率的倒数。通常是以纳秒（nanosecond, 1 纳秒等于10^-9 秒）或皮秒（picosecond, 1 皮秒等于10^-12 秒）为单位

提高程序性能：

- 消除循环的低效率
- 减少过程的调用
- 消除不必要的内存引用

5.9 提高并行性

**执行加法和乘法的功能单元是完全流水线化的，这意味着它们可以每个时钟周期开始一个新操作，并且有些操作可以被多个功能单元执行**

*硬件具有以更高速率执行乘法和加法的潜力，但是代码不能利用这种能力，即使是使用循环展开也不能，这是因为我们将累积值放在一个单独的变量acc中。*

5.9.1   积累多个变量

**对于一个可结合和可交换的合并运算来说，比如说整数加法或乘法，我们可以通过将一组合并运算分割成两个或更多的部分，并在最后合并结果来提高性能**

![](https://gitee.com/andylinchuanxin/bookimagenew/raw/master/img/5-1.png)



![](https://gitee.com/andylinchuanxin/bookimagenew/raw/master/img/5-2.png)



5.9.2  重新结合变换

**从根本上改变合并执行的方式，也极大地提高程序的性能**

1. 重新结合变换能够减少计算中关键路径上操作的数量，通过更好地利用功能单元的流水线能力得到更好的性能
2. 现循环展开和并行地累积在多个值中，是提高程序性能的更可靠的方法

5.10  优化合并代码的结果小结

![](https://gitee.com/andylinchuanxin/bookimagenew/raw/master/img/5-10.png)



5.11.1寄存器溢出

循环并行性的好处受汇编代码描述计算的能力限制。如果我们的并行度/) 超过了可用的寄存器数量，那么编译器会诉诸溢出（spilling)，将某些临时值存放到内存中，通常是在运行时堆栈上分配空间



5.11.2 分支预测和预测错误处罚

保证分支预测处罚不会阻碍程序的效率：

1. 不要过分关心可预测的分支
2. 书写适合用条件传送实现的代码



5.13理解内存性能

现代处理器都包含一个或多个高速缓存（cache)存储器

**加载（从内存读到寄存器）和存储(从寄存器写到内存)操作的程序的性能**

5.13.1  加载的性能

5.13.2  存储的性能



性能提高技术：

1. 高级设计。为遇到的问题选择适当的算法和数据结构。要特别警觉，避免使用那些会渐进地产生糟糕性能的算法或编码技术
2. 基本编码原则。避免限制优化的因素，这样编译器就能产生高效的代码
   - 消除连续的函数调用。在可能时，将计算移到循环外。考虑有选择地妥协程序的模块性以获得更大的效
   - 消除不必要的内存引用。引人临时变量来保存中间结果。只有在最后的值计算出来时，才将结果存放到数组或全局变量中
3. 低级优化。结构化代码以利用硬件功
   - 展开循环，降低开销，并且使得进一步的优化成为可能
   - 通过使用例如多个累积变量和重新结合等技术，找到方法提高指令级并行
   - 用功能性的风格重写条件操作，使得编译采用条件数据传送



5.14  确认和消除性能瓶颈

性能数据的分析工具

- 程序剖析
- 使用剖析程序来指导优化