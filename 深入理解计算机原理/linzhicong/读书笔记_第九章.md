# 第九章 虚拟内存
为什么需要理解虚拟内存：

- 虚拟内存式核心
- 虚拟内存是强大的
- 虚拟内存是危险的

## 1、物理和虚拟寻址
计算机系统的主存被组织成一个有 M 个连续的字节大小的单元组成的数组。每个字节都有唯一的**物理地址**。CPU 使用物理地址访问内存，称为**物理寻址**。

现代处理器使用的是一种称为**虚拟寻址**，CPU 通过生成一个**虚拟地址**来访问主存，这个虚拟地址在被送到内存之前先转换成适当的物理地址。

将一个虚拟地址转换为物理地址的任务叫做**地址翻译**。

## 2、地址空间
地址空间是一个非负整数地址的有序集合

## 3、虚拟内存作为缓存的工具
在任意时刻，虚拟页面的集合都分为三个不相交的子集：

- 未分配的：VM 系统还未分配的页
- 缓存的：当前已缓存在物理内存中的已分配页
- 未缓存的：未缓存在物理内存中的分配页

#### 3.1 DRAM 缓存的组织结构
- SRAM 缓存：表示位于 CPU 和主存之间的 L1、L2 和 L3 高速缓存；
- DRAM 缓存：表示虚拟内存系统的缓存，它在主页中缓存虚拟页；

#### 3.2 页表
页表：将虚拟页映射到物理页。

#### 3.3 页命中
#### 3.4 缺页

## 4、地址翻译
当页面命中时，CPU 硬件执行的步骤：

- 处理器生成一个虚拟地址，并把它传给 MMU
- MMU 生成 PTE 地址，并从高速缓存/主存请求得到它
- 高速缓存/主存向MMU 返回 PTE
- MMU 构造物理地址，并把它传送给高速缓存/主存
- 高速缓存/主存返回所请求的数据给处理器

### 多级页表
多级页表的作用可以减少内存的消耗

## 5、内存映射
Linux 通过将一个虚拟内存区域与一个磁盘上的对象关联起来，以初始化这个虚拟内存区域的内容，这个过程称为**内存映射**。虚拟内存区域可以映射到两种类型的对象中：

- Linux 文件系统中的普通文件
- 匿名文件

## 6、动态内存分配
- 显式分配器：要求应用显式地释放任何已分配的快
- 隐式分配器：要求分配器检测一个分配快何时不再被程序所使用，那么就释放这个快

#### 为什么要使用动态内存分配
因为经常要直到程序实际运行时，才知道某些数据结构的大小。

#### 分配器的要求和目标
- 处理任意请求序列
- 立即响应请求
- 只使用堆
- 对齐块
- 不修改已分配的块

#### 碎片
- 内部碎片：在分配一个已分配块比有效载荷大时发生
- 外部碎片：当空闲内存合计起来足够满足一个分配请求，但是没有一个单独的空闲块足够大可以来处理这个请求时发生

#### 合并空闲块
当分配器释放一个已分配块时，可能有其他空闲块与这个新释放的空间块相邻。这些邻接的空闲块可能引起一种现象，叫做**假碎片**。

为了解决假碎片问题，任何实际的分配器都必须合并相邻的空闲块，这个过程称为**合并**。

## 7、C 程序中常见的与内存有关的错误
- 间接引用坏指针
- 读未初始化的内存
- 允许栈缓冲区溢出
- 指针指向的对象时相同大小
- 造成错位错误
- 引用指针，而不是它所指向的对象
- 误解指针运算
- 引用不存在的变量
- 引用空闲堆块中的数据
- 引起内存泄漏
