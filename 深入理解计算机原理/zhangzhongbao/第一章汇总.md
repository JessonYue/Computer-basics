##  深入理解计算机系统

> 计算机系统是由硬件和系统软件组成的，它们共同工作来运行应用程序。

通读本书不限于解决以下问题：

- 避免由计算机表示数字的方式引起的数字错误（主要在数值的计算超过当前数值的类型引发的溢出；浮点型的精度）
- 优化自己的C代码充分利用现代处理器和存储器
- 了解编译器如何实现过程调用，避免缓冲区溢出带来的安全漏洞
- 避免链接错误
- 编写自己的Unix shell、动态存储分配包，和web服务器
- 理解并发和并发的缺陷

### 1.1信息就是位+上下文

系统中所有的信息：磁盘文件，内存中的程序和数据，网络上传送的数据，都是一串比特表示的（电闸01）。区分不同数据对象依赖上下文环境。在不同的上下文环境中，同样字节序列可能表示一个整数、浮点数、字符串或者机器指令。

### 1.2程序被其他程序翻译成不同的格式

c程序经过GCC编译器转化为低级机器语言指令。然后这些指令按照可执行目标程序的格式打好包，并以二进制磁盘文件方式存放起来。
c语言编译步骤：

- 预处理：gcc -E hello.c -o hello.i 一般是宏定义的展开、include文件引入、条件编译、删除注释。（不检查语法）
- 编译:gcc -S hello.i -o hello.s 生成汇编文件（检查语法）
- 汇编:gcc -c hello.s -o hello.o 生成目标文件
- 链接:gcc hello.o -o hello_elf 编译之后需要把库链接到最终的可执行程序中

### 1.3 了解编译系统如何工作是大有益处的

- 优化程序性能
- 理解链接时出现的错误
- 避免安全漏洞。大部分情况下是指爆栈的情况

### 1.4 处理器读并解释储存在内存中的指令

系统硬件组成：

- 总线：被设计成定长字节块也就是字。大部分系统字长是4字节或8字节
- IO设备：键鼠、显示器，磁盘，网卡
- 主存：临时存储设备，用来存放执行的程序和程序的数据
- 处理器：CPU，核心包含PC，ALU

CPU执行指令可能有如下动作（主要是跳转逻辑和内存通信）

- 加载：从主存复制数据到寄存器
- 存储：从寄存器复制数据到主存
- 操作：将两个寄存器的内容复制到ALU参与运算，并将结果存放到另外一个寄存器
- 跳转：从指令中获取一个字复制到PC中

运行hello程序
用户在shell中输入“hello”->
shell程序将字符读入寄存器->
存放到主存->结束命令的输入->
shell加载可执行的hello文件->将hello目标文件中代码和数据从磁盘复制到主存->执行hello目标文件的main指令->输出“helloworld"字符从主存复制到寄存器->再从寄存器复制到显示设备，最终显示到屏幕上。



大体就是：

- 指令从磁盘读取文件加载至内存，然后复制到处理器
- 数据从磁盘加载至内存，最后又从主存复制到显示设备

处理器与主存之间差异较大，所以在CPU中设计了高速缓存（L1 L2 L3）



###  1.6存储设备的层次结构

从高到低：

- 0.寄存器
- 1.L1高速缓存（SRAM）
- 2.L2高速缓存（SRAM）
- 3.L3高速缓存（SRAM）
- 4.主存（DRAM）
- 5.本地二级存储（本地磁盘）
- 6.远程二级存储（远程文件系统）
- 存储结构主要思想：上一层作为下一层的高速缓存

###  1.7操作系统管理硬件

可以将操作系统看成是应用程序和硬件之间插入的一层软件。所有对硬件的操作都要经过操作系统

软件    应用程序  

        操作系统   

硬件：  处理器 |主存|IO设备

 操作系统的功能：  
 1、防止硬件被乱用  
 2、向应用程序提供API


#### 1.7.1进程

 操作系统实现交错执行进程的机制称为上下文切换。  
 进程运行所需要的的状态信息称为上下文。

 当系统决定将控制权从当前进程转移到某个新的进程，就会进行上下文切换。  
 上下文切换的动作：  
 1、保存当前进程的上下文，恢复新进程的上下文  
 2、将控制权传递到新进程  

 从一个进程切换到另外一个进程是由**操作系统内核**管理的。内核是操作系统代码常驻内存顶部的那部分。

 内核不是独立进程，是管理全部进程所用代码和数据结构的集合

####  1.7.2线程

 线程运行在进程上下文中，并共享同样的代码和全局数据。【有血缘关系的进程读时共享，写时复制】
 相对而言比进程更容易共享数据。

####  1.7.3虚拟内存

 虚拟概念，假象，就像每个进程都在独占的使用主存，每个进程看到的内存都是一致的

 进程的虚拟地址空间（从上到下）

 - kernel PCB
 - env cmd
 - stack
 - so
 - heap
 - bss
 - data
 - text  
 - 

####  1.7.4 文件

在linux中，一切皆文件。IO设备，磁盘，键盘，显示器

### 1.8 系统之间通过网络通信

 系统从主存复制字节到网络适配器，数据经过网络到达另一台主机

### 1.9并发和并行

 并发指一个同时具有多个活动的系统
 1、线程级并发  
 2、指令级并行
 3、单指令多数据并行