

## 第八章

## 异常控制流

### 概述

异常控制流是针对突发的情况或非正常控制流处理的情况作出处理。

* 异常

  不同于我们平时理解的程序异常，程序报错等。异常( exception )就是控制流中的突变，用来响应处理器状态中的某些变化。系统IO操作，并发操作都是通过异常处理流来支持的。

  * 分类

    1. 中断

       异步发生。来自处理器外部的 I/O 设备的信号的结果。例如网络适配器磁盘控制器向CPU发射异常信号，来触发中断。处理器接收到中断信号，调用适当的中断处理程序。当处理程序返回时，它就将控制返回给下一条指令，程序继续执行。

    2. 陷阱

       陷阱是有意的异常，是执行一条指令的结果。陷阱处理程序将控制返回到下一条指令。陷阱最重要的用途是在用户程序和内核之间提供一个像过程一 样的接口，叫做系统调用。

    3. 故障

       故障由错误情况引起，它可能能够被故障处理程序修正。处理器将控制转移给故障处理程序。如果能够修正这个错误 ，它就将控制返回到引起故障的指令，重新执行。否则就回到内核的终止例程，系统终止应用程序。例如缺页异常。

    4. 终止

       终止是不可恢复的致命错误造成的结果，通常是一些硬件错误。处理程序不会将控制权返回给应用程序，会终止这个程序。

### 进程

进程是一种抽象，正在运行的程序的抽象。它提供一种假象，我们运行的程序好像独占了处理器和内存。而实际上处理器和内存是被多个程序共用的。真实情况可能是处理器执行进程A的某个指令，然后再去执行进程B的某个指令，所有程序的指令就这样交替的执行着。

 * 逻辑控制流

   处理器的物理流被多个进程分成多个部分，每个进程的指令处理序列称为这个进程的逻辑控制流。

   一个逻辑流的执行在时间上与另一个流重叠，称为并发流。如果两个流并发地运行在不同的处理器核或者计算机上，那么我们称它们为并行流。

* 每个进程都有私有的地址空间

* 用户模式和内核模式

  处理器通常是用某个控制寄存器中的一个模式位来控制模式的切换，该寄存器描述了进程当前的权限。

  用户模式中的进程不允许执行特权指令，例如停止处理器、改变模式位，或者发起一个 I/O操作。进程从用户模式变为内核模式的 唯一方法是通过诸如中断、故障或者陷人系统调用这样的异常。异常发生时，处理器将模式变为内核模式，处理程序运行在内核模式，当运行完返回时，处理器将模式改回到用户模式。

* 上下文切换

  每个进程都有一个上下文context，包含进程的状态，例如通用目的寄存器、浮点寄存器、程 序计数器、用户栈、状态寄存器、内核栈和各种内核数据结构。内核通过切换进程的上下文，实现进程的切换和调度。执行系统调用(例如磁盘访问)、中断(例如定时器)都可能会发生上下文切换

### 信号

一种更髙层的软件形式的异常，一个信号就是一条小消息，它通知进程系统中发生了一个某种类型的事件。系统可以发送信号给目的进程，通知它发生了一个事件，目的进程接收到信号，通过信号处理程序来处理。可以用来进程间的通信。

 * 发送信号

   内核通过更新目的进程上下文中的某个状态，发送(递送)一个信号给目的进程。可能是系统事件(例如除零错误)、系统终止了进程(发送信号给目的进程)。

 * 接受信号

   目的进程被内核强迫以某种方式对信号的发送做出反应。进程可以忽略这个信号，终止或者通过执行一个称为信号处理程序来捕获处理这个信号。

   发出而没有被接收的信号叫做待处理信号。在任何时刻，一种类型至多只会有一个待处理信号。

 * 阻塞信号和恢复阻塞信号

   内核默认阻塞任何当前处理程序正在处理信号类型的待处理的信号。应用程序可以使用 sigprocmask函数和它的辅助函数，明确地阻塞 和解除阻塞选定的信号。



