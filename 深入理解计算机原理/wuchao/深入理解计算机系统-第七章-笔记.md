## 第七章

## 链接

### 定义

	* 将各种代码和数据片段收集并组合成为一个单一文件的过程

### 静态链接

	* 在编译时将目标文件链接到可执行文件中。

 * 过程

    * 符号解析

      将目标文件中的符号引用和一个符号定义关联起来。需要找到这个符号引用的定义。如果找不到则会报错。符号对应一个函数、全局变量、静态变量。

      * 符号种类
        1. 全局符号。本模块中可以被其他模块引用的符号，即本模块中的非静态函数和全局变量。
        2. 外部符号。本模块中引用的在其他模块中定义的符号。即其他模块中的非静态函数和全局变量。
        3. 局部符号。本模块中的静态函数和静态全局变量。
      * 对于多重定义的符号的解析
        * 在本模块中，局部符号只允许有一个定义。
        * 对于全局符号，不允许有多个强符号。强符号即被初始化的符号。弱符号即未被初始化的符号。
        * 对于全局符号，如果存在强符号和弱符号同名，选择强符号。
        * 对于全局符号，如果存在多个弱符号，任意选择一个。

   * 重定位

     * 重定位节(section)和符号定义

       将输入模块的同一类型的节合并为一个节。将运行时内存地址赋给每个节以及定义的符号。

     * 重定位节(section)中的符号引用

       将节中的符号引用指向正确的运行时内存地址。

### 动态链接

 * 在程序运行或加载时，再将目标模块加载到内存中，然后将其和程序链接起来。

* 共享库代码的处理

  编译器通过在编译共享库时生成位置无关代码PIC，即可被加载而无需重定位的代码段。来支持多个进程共享一个共享模块的代码段的单一副本，即共享指令。这样就避免了多个进程都为共享代码分配内存，难以维护的情况。所以我们需要共享库的代码是跟地址无关的。但是需要解决共享代码的数据和过程的引用问题，即如何找到他们的绝对地址。

  * 解决全局PIC数据引用

    利用数据段和代码段的相对距离是不变的特性。在数据段开始的地方生成全局偏移量表(GOT)。在加载时，动态链接器通过重定位GOT中的每个条目，生成目标的绝对地址。

  * 解决全局PIC过程引用

    通过延迟绑定技术，GOT和过程链接表(PLT)来协作。PLT每个条目都负责调用一个具体的函数。GOT里保存动态链接需要的信息，和动态链接器的地址。在第一次调用目标函数时，PLT会将函数的ID和动态链接器所需要的参数压入栈，然后跳转到动态链接器，动态链接器会解析出函数地址，将这个地址填到GOT，然后执行目标函数。第二次调用就可以直接用GOT里保存的目标函数地址来实现调用了。

    这样做的好处是，避免了没有调用的函数动态链接时不必要的重定位的工作。

### 动态链接和静态链接的对比

 * 静态链接生成的代码维护起来麻烦，如果目标文件做了变动，就需要重新链接。

 * 相同的目标文件被链接到多个程序中，造成内存资源的浪费。

* 动态链接的高灵活性，是以牺牲性能为代价的。数据和过程的引用需要根据GOT相对寻址。因此比静态链接耗费更久的时间。

  

