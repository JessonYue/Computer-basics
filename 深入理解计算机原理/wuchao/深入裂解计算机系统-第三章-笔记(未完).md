## 第三章

## 程序的机器级表示

* 程序编码过程

  1. C预处理器扩展源代码，将#include 指定的文件插入，扩展#define 声明的宏。
  2. 编译器将源代码处理生成汇编代码。
  3. 汇编器将汇编代码转化成二进制目标代码文件。
  4. 链接器将目标代码文件和实现库函数（如printf）的代码合并。生成可执行二进制代码文件。

* 处理器状态

  1. 程序计数器（PC）。存放要执行的下一条指令在内存中的地址。
  2. 整数寄存器文件。16个命名位置，每个存储64位的值。存储地址或整数数据。指令可以单独访问每一个寄存器低一个字节（8位），低一个字（16位），低双字（32位），或一整个寄存器。
  3. 条件码寄存器。保存最近执行的算术或逻辑指令的状态信息。实现控制或数据流中的条件变化
  4. 向量寄存器。存放整数或浮点数。

* 程序内存

  包含可执行机器代码、操作系统需要的一些信息，用来管理过程调用、返回的运行时栈、用户分配的内存块。

  程序内存用虚拟内存来寻址。

  操作系统负责管理虚拟内存地址空间，将虚拟地址翻译成物理地址。

* C程序中插入汇编代码

  1. 用汇编代码编写完整的函数，放到一个独立的汇编代码文件中，然后用汇编器和链接器，把它和C书写的代码合并起来。
  2. 利用GCC的内联汇编（inline assembly）特性，在编译的时候，用伪ASM指令，在C代码中包含汇编代码。

* 操作数指示符

  一般一条指令后面可以跟一个或者多个操作数。操作数指示出操作需要用到的源数据，或放置结果的地方。

  1. 立即数，即常量

  2. 寄存器的值

  3. 内存引用

     根据计算出来的地址，来访问某个内存位置，M[Addr]表示内存中Addr地址开始的b字节值的引用。

     多种寻址方式：

     1. 绝对寻址，即M[内存地址值]
     2. 间接寻址，即M[寄存器的值]，先找到指定寄存器，取出该寄存器的值，然后再寻址内存。在此基础上可以加上偏移量或乘以比例或加上别的寄存器的值。

* 数据传送指令

  将一个数据从源位置复制到目标位置。

  以MOV为例，它有两个操作数，源操作数指定的一个值是立即数，存在寄存器或者内存中。目标操作数指定的是寄存器或内存地址。

  x86-64加了一条限制，即将内存中的一个值复制到另外一个内存位置需要两条指令，第一条指令将源数据加载到寄存器，第二条指令将寄存器的值写入到目标位置。

  

  