## 第五章

## 优化程序性能

### 针对循环的优化

* 循环展开

  通过增加每次迭代计算的元素的数量，减少循环的迭代次数。

* 从并行度的角度

  1. 并行累积多个值

     因为处理器的有多个执行运算的单元，因此可以同时执行多个运算。对于累积值，可以拆分成多个累计值，保存多个同时进行的运算值。最后再将他们合并成一个累计值。

  2. 通过重新结合变换，减少数据的相关联，那么也就增加了并行性，让一些操作可以不用等待就可以执行。

  3. 降低内存读写的相关性，提高加载和存储的并行性。

### 优化的限制因素

 * 寄存器的大小

   如果局部变量的数量超出了寄存器的大小，则会在栈上分配，那么就会降低读写数据的性能。累积多个值的优势可能就没有了。

* 分支预测处罚

  基于处理器流水线的设计。为了执行效率，流水线上会排满指令。在遇到分支时，会使用分支预测，达到这个目的。但是如果出现分支预测错误，则需要重新用指令填充流水线，导致分支预测处罚，极大的浪费性能。

  改进：1. 让代码的条件能更容易预测。 2. 书写适合用条件传送的代码。

  