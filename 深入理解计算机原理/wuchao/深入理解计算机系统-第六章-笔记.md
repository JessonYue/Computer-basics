## 第六章

## 存储器层次结构

### 概述

* 存储器层次结构是从处理器到网络，越靠近cpu的存储器层次越高，读写速度更快，存储容量小，造价更高。高层次的存储器作为低层次存储器的高速缓存。类似一个金字塔的结构。

### 局部性

* 局部性描述了一种倾向。程序更倾向于引用邻近于其他最近引用过的数据项的数据项，或者最近引用过的数据项本身。即指离处理器更近的存储器中的数据更频繁的被使用到，这意味着更倾向于从存储层次高的存储器中读写数据。这种倾向的目的即是让处理器的处理效率更高。

* 时间局部性

  倾向于使用同一块内存区域，被引用过一次的内存位置很可能在不远的将来再被多次引用。

* 空间局部性

  倾向于使用相邻的内存区域，如果一个内存位置被引用了一次，那么程序很可能在不远的将来引用附近的一个内存位置。

* 利用好



### 缓存

 * 目的

   缓存作为实现局部性的手段，目的是为了让处理器处理效率更高。属于空间换时间的做法。

   为了弥补存储器之间的性能差距，通过把低层次的存储器的数据缓存到高层次的存储器中。下次需要访问这些数据时，则可以不用从低层次的存储器中获取，直接从高层次的存储器中获取。

 * 缓存不命中

   即没有从缓存中找到目标数据。这时需要放置策略来决定，新缓存的数据放在哪里，这里可能会替换掉原先的数据。

* 高速缓存的设计思想

  * 结构

    高速缓存以如下的方式来组织所有的块。将连续的内存块映射到缓存组中。

    缓存的一行包含有效位(标记是否存有缓存数据)、标记位(用来匹配是哪一行)、块(存放缓存的数据)。

    每一组包含一个或多个行(直接映射一行、组相连和全相连多行)，而整个缓存包含多个组。

  * 寻址

    由于高速缓存结构的划分，高速缓存的地址包含三个部分，组的索引(定位哪一组)、标记位(定位哪一行)、块偏移(定位块中的起始字节)。通过这个地址寻址到高速缓存中的位置，确定是否有缓存数据，如果有就返回。包含三个步骤：1. 选择组 2. 选择行 3. 抽取字

    这里有一个很有意思的地方。即组的索引位是地址中间的位，而不是高位(高位放的是标记位)。为什么这么做呢？这样做可以让连续的块映射到多个组中，缓存均匀的分布，加大了缓存的使用效率。感觉有点类似散列表的散列思想。

* 时间和空间的局部性

  良好的时间局部性，即使用同一块高速缓存，处理器不用从低层次存储器中反复加载数据。

  良好的空间局部性，即用到的都是相邻的块，因为所有缓存的结构都是将数据存储为连续的块。降低了缓存不命中的概率。



