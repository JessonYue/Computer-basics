# 异常控制流

## 为什么要理解异常控制流

1、理解 ECF 将帮助你理 解重要的系统概念。

2、理解 ECF将帮助你理解应用程序是如何与操作系统交互的。

3、理解 ECF将帮助你编写有趣的新应用程序。

4、理解 ECF 将帮助你理解并发。

5、理解 ECF 将帮 助你理 解软件异常如何工作。

## 异常

### 什么是异常

异常是异常控制流的一种形式，它一部分由硬件实现，一 部分由操作系统实现。异常( exception )就是 控制流 中的突 变，用来响应处理器状态中的某些变化。

### 异常怎么处理

### 异常的分类

1、中断：中断是异步发生的，是来自处理器外部的 I/O 设备的信号的结果。

2、陷阱和系统调用：陷阱是有意的异常，是执行一条指令的结果。就像中断处理程序一样，陷阱处理程序 将控制返回到下一条指令。陷阱最重要的用途是在用户程序和内核之间提供一个像过程一 样的接口，叫做系统调用。

3、故障：故障由错误情况引起，它可能能够被故障处理程序修正。当故障发生时，处理器将控 制转移给故障处理程序。

4、终止：终止是不可恢 复的致 命错误 造成的 结果，通常是 一些硬 件错误 ，比如 DRAM 或者 SRAM 位被损坏时发生的奇偶错误。终止处理程序从不将控制返回给应用程序。

### Linux中存在哪些异常

1、Linux/x86-64 故障 和终止包括：除法错误、一般保护故障、缺页、机器检查。

2、系统调用：Linux系统上有数百个系统调用，比如常用的读文件、写文件、创建进程等等，这些系统调用都有一个唯一的整数编号：由于历史的原因，系统调用通过异常128来处理（0x80）提供。

## 进程

### 什么是进程

在现代系统上运行一个程序时，我们会得到一个假象，好像每个程序都在独占处理器和地址空间。

进程 提供给应用程序的关键抽象 :

1、一个独立的逻辑控制流，它提供一个假象，好像我们的程序独占地使用处理器。

2、一个私有的地址空间，它提供一个假象，好像我们的程序独占地使用内存系统。

### 进程的逻辑控制流是怎么

三个逻 辑流的进程A 进程B 进程C逻辑控制流。进程为每个程序提供了一种假象, 好像程序在独占地使用处理器。每个竖直的条 表示一个进程的逻辑控制流的一部分时间执行是交错的。进程 A 运行了一会儿 ，然后是进程 B 开始运行到完成。然后 ，进程 C 运 行了一会儿，进程 A接着运行直到完成。最后，进程 C可以运行到结束了。进程是轮流使用处理器的。每个进程执行它的流的一部分，然 后被抢占(preempted)(暂时挂起)，然后轮到其他进程。对于一个运行在这些进程之一的 上下文中的程序，它看上去就像是在独占地使用处理器。

### 进程中的私有地址空间是什么样的

进程为每一个程序提供它自己的私有地址空间，地址空间底部是保留给用户程序的，包括通常的代码、数据、堆和栈段。代码段总是 从地址 0x400000 开始。地址空间顶部保留给内核(操作系统常驻内存的部分)。地址空间 的这个部分包含内核在代表进程执行指令时(比如当应用程序执行系统调用时)使用的代码、数据和栈。

### 用户模式和内核模式的概念

处理器为了安全起见，不至于损坏操作系统，必须限制一个应用程序可执行指令能访问的地址空间范围。就发明了两种模式用户模式和内核模式，其中内核模式有最高的访问权限，甚至可以停止处理器、改变模式位，或者发起一个I/O操作，处理器使用一个寄存器当作模式位，描述当前进程的特权。进程只有当中断、故障或者陷入系统调用时，才会将模式位设置成上帝模式，得到内核访问权限，其他情况下都始终在用户权限中，就能够保证系统的绝对安全。

### 进程的之间的上下文切换机制

内核为每个进程维持一个上下文(context)。上下文就是内核重新启动一个被抢占的进 程所需的状态。它由一些对象的值组成，这些对象包括通用目的寄存器、浮点寄存器、程 序计数器、用户栈、状态寄存器、内核栈和各种内核数据结构，比如描述地址空间的页 表、包含有关当前进程信息的进程表，以及包含进程已打开文件的信息的文件表。在进程执行的某些时刻，内核可以决定抢占当前进程，并重新开始一个先前被抢占了 的进程。这种决策就叫做调度(scheduling), 是由内核中称为调度器(scheduler)的代码处 理的。

## 进程控制

### 创建和终止进程

创建：使用fork（）函数通过系统调用创建一个与原来进程几乎完全相同的进程，除了PID不同外，子进程可以读写父进程中打开的任何文件。一个进程调用fork（）函数后，系统先给新的进程分配资源，例如存储数据和代码的空间。然后把原来的进程的所有值都复制到新的新进程中，只有少数值与原来的进程的值不同。相当于克隆了一个自己。fork函数有一个特别的地方，虽然只被调用一次，却能返回两次。

终止：进程会因为三种原因终止:1)收到一个信号，该信号的 默认行为是终止进程，2)从主程序返回，3)调用 exit 函数。

### 回收子进程

当父进程回收已终止的子 进程时，内核将子进程的退出状态传递给父进程，然后抛弃已终止的进程，从此时开始, 该进程就不存在了。这时候就需要用到waitpid函数，如果调用waitpid函数时，等待的子进程已经运行结束，该函数会立即返回。否则父进程会被阻塞，暂停运行。

### 进程休眠

调用sleep函数和pause函数可让进程休眠。

### 怎么加载并运行程序

execve 函数在当前进程的上下文中加载并运行一个新程序。execve函数加载并运行可执行目标文件 filename, 且带参数列表 argv 和环境变量 列表 envpÿ 。

### 利用fork和execve运行程序

像 Unix shell 和 Web 服务器这样的程序大量使用了 fork 和 execve 函数。

## 信号

一个信号就是一条小消息，它通知进程系统中发生了一个某种类型的事件。

### 发送信号

1、用/bin/kill程序发送信号。

2、从键盘发送信号。

3、用 kill 函数发 送信号。

4、用 alarm函数发送信号

### 接收信号

当程序运行的时候，如果接收到了信号，就会把控制权转移到信号处理程序中，执行完信号处理程序以后才返回程序的下一条指令继续运行。

### 信号处理原则

程序只是捕获一个信号进行处理，当有多个信号到达时，如何处理，遵循下列原则：

1、待处理信号被阻塞。

2、待处理信号不会排队等待。

3、系统调用可以被中断。