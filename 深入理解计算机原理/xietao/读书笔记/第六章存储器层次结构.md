# 第六章存储器层次结构

## 存储器都包含什么？

1、随机访问存储器分为静态SRAM和动态DRAM。

2、存储器模块：是将多个DRAM组合起来，聚合内存。

3、访问主存包括读事务和写事务。读事务就是首先，CPU 将地址 A 放到系 统总线上。I/O桥将信号传递到内存总线 接下来，主存感觉到内存总线上的地 址信号，从内存总线读地址，从 DRAM 取出数据字，并将数据写到内存总线。I/O桥将最后，CPU 感觉 到系统总线上的数据，从总线上读数据，并将数据复制到寄存器。写事务：首先, CPU将地址放到系统总线上。内存从内存总线读出地址，并等待数据到达接下 来，CPU 将%1:故中的数据字复制到系统总线 最后，主存从内存总线读出数据 字，并且将这些位存储到 DRAM 中。

4、磁盘存储

​	1、磁盘以扇区为单位来读写数据，对扇区的访问时间由三个部分组成：寻道之间、旋转时间、传送时间。

​    2、逻辑磁盘块：在磁盘中有一个小固件，磁盘控制器，维护着磁盘扇区之间的映射关系。

​	3、逻辑磁盘块：当我们对磁盘进行分区以前都要求我们进行格式化，这样做是让磁盘控制器，读取磁盘的基础内容，同时建立备用扇区，当一个扇区不能访问的时候，磁盘控制器启用备用扇区，这样使得磁盘更健壮，不会因为一点点损坏就不能使用了。备用扇区可能相当的大。

   4、当读取磁盘的时候：CPU发送一个命令，要求读磁盘内容，要求读完以后报告给CPU进行中断；2、 指明要读取的具体逻辑块号码。3、 指明拷贝到主存的地址。

总结：现代计算机频繁地使用基于 SRAM 的高速缓存， 试图弥补处理器-内存之间的差距。这种方法行之有效是因为应用程序的一个称为局部性 (locality)的基本属性。

## 为什么引入局部性

在一个具有良好时间局部性的程序中，被引用过一次的内存位置很可能在不远 的将来再被多次引用。在一个具有良好空间局部性的程序中，如果一个内存位置被引用了 一次，那么程序很可能在不远的将来引用附近的一个内存位置。也就是说我们在这一刻访问到的磁盘数据在下一刻也可能会被访问。局部性分为：时间局部性和空间局部性。

## 怎么样编写良好的局限性程序

1.重复引用同一个变量的程序有良好的时间局部性；

2.具有步调长度为k的引用模式程序，步调越小，空间局部性越好。

## 存储器层次结构

1、高速缓存的基本原理：

2、什么是缓存命中：当程序需要第k+1层数据块14的时候，程序会在当前存储的k层，寻找块1的数据，刚好1在k层的话，就是一个缓存命中，这比从k+1层读取的速度要快很多。

3、什么是缓存不命中：当程序需要访问到块12的时候，在k层没有该数据块，就是一个缓存不命中，这时候就会从k+1层中读取块2将其替换到k层的一个数据块（覆盖或驱逐一个已有的数据块）。程序还是从k层访问块2。

4、什么是放置策略：如果我们从k+1层中获得的数据随机的放置在k层，这样的随机放置就会导致访问的效率降低，我们的放置策略是块i必须放置在（imod4）中，也就是0，4，8，12会映射到同一个k层的块0中。这就会导致一个冲突不命中，也就是说如果程序交替请求k+1层的0，4块，由于会一直映射到k层的0块中，这时候虽然k层有空余的缓存，但还是每次不命中。

总结：利用时间的局部性，同一数据对象可能会被多次使用，一旦一个数据对象在第一次不命中的时候被拷贝到缓存中，我们就会期望在接下来的访问中有一系列的命中率。利用空间的局部性，由于一个数据块并不仅仅只有一个数据，而是一系列数据块的集合，我们访问到块子集a的时候，可能会继续访问块的子集b。



## 高速缓存存储器

 什么是高速缓存存储器：简单的来说就是集成在CPU内部的一个部件分为L1，L2，L3三级缓存。高速缓存的分类如下：

1、通用高速缓存存储器内部结构：高速缓存是一个数组，每个组包含一个或多个行，每个行有一个有效位、一个标记位，以及数据块。我们进行访问的地址结构就是：t的标记位+s个组索引+b个块偏移。

2、直接映射高速缓存：命中缓存为组选择、行匹配、字抽取。

3、组组连高速缓存。

4、全相连高速缓存。

在Intel Core i7处理器的高速缓存层次结构：每个 CFU 芯片有四个核。 每个核有自E私有的LI i-cacheÿ LI 和 L2 统一的高速缓存。所有的核共享片上 L3 统一的高速缓存。这个层次结构的一个有趣的特性是所有的 SRAM 高速缓存存储器都 在 CPU 芯片上。

##  怎样编写高速缓存友好代码

1、对局部变量的反复引用是好的，因为编译器能够将它们缓存在寄存器文件中(时间

局部性 )。

2、步长为 1 的引用模式是好的，因为存储器层次结构中所有层次上的缓存都是将数据

存储为连 续的块(空间局部性 )。

3、



##  

