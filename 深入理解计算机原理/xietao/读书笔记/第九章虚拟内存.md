# 虚拟内存

## 为什么需要了解虚拟内存

1、虚拟内存是核心的 。虚拟内存遍及计算机系统的所有层面，在硬件异常、汇编器、 链接器、加载器、共享对象、文件和进程的设计中扮演着重要角色。理解虚拟内存 将帮助你更好地理解系统通常是如何工作的。

2、虚拟内存是强 大的。虚拟内存给予应用程序强大的能力，可以创建和销毁内存片(chunk)ÿ 将内存片映射到磁盘文件的某个部分，以及与其他进程共享内存。比如， 你知道可以通过读写内存位置读或者修改一个磁盘文件的内容吗?或者可以加载一 个文件的内容到内存中，而不需要进行任何显式地复制吗?理解虚拟内存将帮助你 利用它的强大功能在应用程序中添加动力。

3、虚拟内存是危险的。每次应用程序引用一个变量、间接引用一个指针，或者调用一个 诸如 malloc 这样的动态分配程序时，它就会和虚拟内存发生交互。如果虚拟内存使 用不当，应用将遇到复杂危险的与内存有关的错误。

## 怎么样实现了虚拟内存

## 1、物理寻址和虚拟寻址

主存的每个地址都是唯一的，第一个字节地址为0，接下来为2，以此类推。CPU使用这种访问方式就是物理寻址。上图所示就是CPU通过地址总线传递读取主存中4号地址开始处的内容并通过数据总线传送到CPU的寄存器中。使用虚拟寻址，CPU通过生成一个虚拟地址来访问主存，这 个虚拟地址在被送到内存之前先转换成适当的物理地址。

## 2、地址空间

地址空间是一个非负整数的集合{0，1，2，……}，一个32位的系统中有：2^32 = 4 294 967 296B（4GB）个有效地址。地址空间的概念很重要，我们必须要清楚数据对象（字节）和它的属性（地址）的区别， 举个例子：我和我老婆住在苍溪县xx小区7栋1单元，这个就是我的属性：地址。另外，住在家的我和我老婆就是数据对象（字节）。虚拟存储器的基本思想是：主存中的每个字节都有一个选自虚拟地址空间的虚拟地址和一个选自物理地址空间的物理地址。

## 虚拟地址到物理地址是如何转换

虚拟存储器的主要思想就是：在主存中缓存硬盘上的虚拟页（pagefile.sys），虚拟页有三个状态：未分配、缓存的、未缓存的。

### 1、页表

页表是一个存放在内存中的数据结构，MMU就是通过页表来完成虚拟地址到物理地址的转换。这个数据结构每一个条目称为PTE（Page Table Entry），由两部分组成：有效位和n位地址段。有效位如果是1，那么n位地址就指向已经在内存中缓存好了的地址；如果为0，地址为null的话表示为分配，地址指向磁盘上的虚拟内存（pagefile.sys）的话就是未缓存。

### 2、页命中

地址 翻译硬件将虚 拟地址作为一个索引来定位 PTE 2, 并从内存中读取它。因为设置了有效位，那么地址翻 译硬件就知道 VP 2 是缓存在内存中的了。所以它使用 PTE 中的物理内存地址(该地址指 向 PP1 中缓存页的起始位置)，构造出这个字的物理地址。

### 3、缺页

在虚拟内存的习惯说法中，DRAM 缓存不命中称为缺页。

## 虚拟内存的作用

1、简化链接。

2、简化加载。

3、简化共享。

4、简化内存分配。

## 地址翻译

从形式上来说就是建立一个虚拟地址空间到物理地址空间的映射关系，我们前面说过MMU使用的是页表来实现这种映射。CPU中有一个专门的页表基址寄存器（PTBR）指向当前页表，使用页表进行翻译的时候方法如下：每个虚拟地址由两部分组成：虚拟页号（VPN）+虚拟页偏移量（VPO），当CPU生成一个虚拟地址并传递给MMU开始翻译的时候，MMU利用虚拟地址的VPN来选择相应的PTE，同时将页表中的物理页号（PPN）+虚拟地址的VPO就生成了相应的物理地址。

### 怎么样提高地址翻译的速度

#### 1、加入高速缓存

高速缓存被放在存储器和MMU之间，可以缓存页表条路。当MMU发送一个PTEA请求的时候，优先从高速缓存中寻找相应的PTE值，如果命中直接返回给MMU，如果不命中从内存中获得并发送到高速缓存，再由高速缓存返回到MMU。

#### 2、利用TLB加速地址翻译

TLB是一个小的、虚拟寻址的缓存，其中每一行都保存一个PTE块，高度相连。主要是提供虚拟地址到物理地址的翻译速度

#### 3、加入多级页表

#### 4、端到端的地址翻译

## 案例研究：Intel CoreI7/ Linux存储系统

### Corei7地址翻译

Core i7采用4级页表层次结构，CPU产生的虚拟地址，如果命中由TLB生成物理地址，如果不命中后通过4级页表生成物理地址。物理地址如果命中优先从L1高速缓存中获取数据，如果不命中再从主存中获取结果，最后传递给CPU

### Linux 虚拟内存系统

由下往上是内核的代码和数据结构，是每个进程共享的数据结构和代码；再往上是一组连续的虚拟页面映射到相应的物理页面的物理存储器，大小同主存一样大，提供很方便访问物理页面的任何位置。最后是每个进程不同的是页表、task（mm）、内核栈等。

### 内存映射

Linux 通过将一个虚拟内存区域与一个磁盘上的对象(object)关联起来，以初始化这 个虚拟内存区域的内容，这个过程称为内存映射(memory mapping)。

#### 什么是共享对象

一个对象可以被映射到虚拟内存的一个区域，要么作为共享对象，要么作为私有对 象。如果一个进程将一个共享对象映射到它的虚拟地址空间的一个区域内，那么这个进程 对这个区域的任何写操作，对于那些也把这个共享对象映射到它们虚拟内存的其他进程而 言，也是可见的。

## 动态内存如何分配

1、显式分配：程序调用malloc和free函数。

2、隐式分配：要求分配器检测一个已分配块何时不再被程序所使用，那么就释放这个块。

## 垃圾收集

垃圾收集是一种很有用的方法，当使用了malloc分配了空间却忘记了释放，就会造成内存的极大浪费。垃圾收集就是使用特殊的方法，定期回收这部分不使用或者无效的空间。垃圾收集器将存储器视为一张有向的图，根节点保存在寄存器、栈变量或者虚拟存储器的全局变量中，子节点在堆中，每个子节点对于一个已分配的块。白色为可到达，蓝色为不可到达应该被回收的区域。

