## 										静态链接

按序叠加：就是将输入的目标文件按照次序低价起来。

缺点：容易造成空间浪费。

相似段合并：就是将相同性质的段合并到一起。将相同的段合并为一个段进行输出。

例如：将所有的如输入文件的“.text”段合并到输出文件的“.text”段。

特别注意：在装载时链接器在合并多个段的时候，也会将“.bss”合并，并且重新分配虚拟空间。

整个链接过程分为两步：

1、空间与地址分配：扫描所有的输入目标文件，并且获得它们的各个段的长度、属性和位置，并且将输入目标文件中的符号表中所有的符号定义和符号引用收集起来，统一放到全局符号表中。

2、符号解析与重定位：使用上面收集到的所有信息，读取输入文件中段的数据、重定位信息，并且进行符号解析与重定位、调整代码中的地址等。

重定位：就是链接器在完成地址和空间分配之后就已经可以确定所有符号的虚拟地址了，这时，链接器就可以根据符号的地址对每个使用占位地址的指令进行修正。

每一个ELF文件中都有一个对应的重定位表，用于描述如何修改相应的段里面的内容。

日常开发当中，会出现某个类里面的参数找不到，就是因为链接器发现 属性并没有被定义，从而无法完成链接工作。

绝对寻址修正后的地址为该符号的实际地址，相对寻址修正后为该符号距离被指正的地址差。

如果一个函数放到.init段，在main函数执行前系统就会执行它，同理，如果将一个函数放到.fint段，在main函数返回后该函数就会被执行。利用这两个特性，C++的全局构造和析构就是由此实现的。

两个目标文件必须满足一下哦条件才能链接：

1、采用同样的目标文件格式

2、拥有童颜的符号修饰标准

3、变量内存分布方式相同

其中我们把符号修饰标准、变量内存分布、函数调用方式等这些跟可执行代码二进制兼容性的内容称为ABI（Application Binary Interface）。

API与ABI区别：

API 往往时至源代码级别的接口。

ABI 指的是二进制层面的接口。

其中一个静态库可以简单的堪称一组目标文件的集合，即很多目标文件经过压缩打包后形成的一个文件。

| C运行库     | 相关DLL      | 描述                                        |
| ----------- | ------------ | ------------------------------------------- |
| libcmt.lib  |              | Multithreaded Static 多线程静态库           |
| msvcrt.lib  | msvcr90.dll  | Multithreaded Dynamic 多线程动态库          |
| libcmtd.lib |              | Multithreaded Static Debug 多线程静态调试库 |
| msvcrd.lib  | msvcr90d.dll | Multithreaded Dynamic 多线程静态调试库      |

绝大部分情况下，我们使用链接器提供的默认链接规则对目标文件进行链接。

控制链接器有三种方法：

1、使用命令行来个链接器制定参数。

2、将链接器指令存放在目标文件里面，编译器经常会痛哟这种方法想链接器传递指令

3、使用链接控制脚本。

![image-20200624235235011](/Users/liuchang/Library/Application Support/typora-user-images/image-20200624235235011.png)

![image-20200624235245938](/Users/liuchang/Library/Application Support/typora-user-images/image-20200624235245938.png)



在本章首先了解到目标文件在被链接成最终可执行文件时，输入目标文件中的各个段，会通过不同的方式，将文件中的各个段合并输出到输出文件中，并且进行重新分配输出文件中的空间和地址，一旦最终地址被确定，接下来就将进行符号的解析和重定向，从而获得只想它们的正确位置，然后了解到了COMMON块和目标文件相互链接需要满足多重条件，最后学习到通过链接脚本将输入文件转为输出文件。

