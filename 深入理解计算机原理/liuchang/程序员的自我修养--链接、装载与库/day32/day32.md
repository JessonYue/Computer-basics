## 										运行库实现

### 1、C 语音运行库

CRT遵循原则：

1、Mini CRT 应当以 ANIS C的 标准库为目标，尽量做到与其接口相一致

2、具有自己的入口函数（mini_crt_entry)

3、基本的进程相关操作（exit）

4、支持堆操作（malloc、free）

5、支持基本的字符串操作（fopen、fread、fwrite、fclose、fseek）

6、支持格式化字符串和速出操作（printf、sprint）

7、支持atexit()函数

#### 1、入口函数

程序运行的最初入口点不是main函数，而是由运行库为其提供的入口函数，它主要负责三部分工作：

1、准备好程序运行环境及初始化运行库

2、调用 main 函数执行程序主体

3、清理程序运行后的各种资源

入口函数命名为 mini_crt_entry。

void mini_crt_entry(void){

​	//初始化部分

​	int ret = main（）；

​	//结束部分

​	exit（ret）；

}

#### 2、CRT 初始化

完成了获取 main 函数参数的代码后，还应该在入口函数里对 CRT 进行初始化。由于 Mini CRT 所实现的功能较少，所以初始化部分十分简单。需要初始化的主要是堆和IO 部分。 在堆被初始化之前，malloc/free 函数是没有办法使用的。我们定义堆的初始化函数为 mini crt heap init()；IO 部分的初始化闲数为 mini crt io 。这两个函数的返回值都是整 数类塑的，返回非 0 即表示初始化成功，否则表示失败。这两个函数的实现将在后面介绍堆 实现和I0 实现时详细介绍。

#### 3、结束部分

它要完成两项任务：

1、调用有 atexit（）注册的退出回调函数

2、实现进程结束

#### 4、堆的实现

Mini CRT 堆的实现归纳为几点：

1、实现一个以空闲链表算法为基础的堆空间分配算法

2、堆空间大小固定为32MB，初始化之后空间不在扩展或缩小

3、在 Linux 平台下，使用 brk 将数据段结束地址向后调整 32 MB ，将这块空间作为堆空间。

整个堆空间按照是否被占用而被分割成了若干个空闲（Free）块和占用（Used）块，它们之间有双向链表链接起来。

### 2、如何使用 Mini CRT

一般一个 CRT 提供给最终用户时往往有两部分，一部分是 CRT 的库文件部分，用于与 用户程序进行链接，如 Glibc 提供了两个版本的库文件；静态 Glibc 库 libc.a 和动态 Glibc 库 libc.so;MSVC CRT 也提供了静态和动态版本，libcmUib 与 msvcrt90.dll 。CRT 的另外一部 分就是它的头文件，包含了使用该 CRT 所需要的所有常数定义、宏定义及函数声明，通常 CRT 都会有很多个头文件。

### 3、C++运行库实现

#### 1、new 与 delete

new 操作的功能是从堆上分配 块对象大小的空间，然后运行对象的初始化函数将这个 空间地址返回:而 delete 则是与 new 相反的操作 它首先运行对象的析构函数，然后释放堆 空间。

#### 2、C++ 全局构造与析构

MSVC CRT 与 Glibc 在实现上稍有不同的是，MSVC CRT 只需要一个目标文件就可以 实现全局构造，编译器会按照段名将所有的输入段排序;而 Glibc 需要两个文件；ctrbegin.o 和 cnend.o, 这两个文件在编译时必须位于输入文件的开始和结尾部分，所有在这两个文件 之外的输入文件中的“.ctor”段就不会被正确地合并。

#### 3、atexit实现

实现它的基本思路也很简申，就是使用一个链表把所冇注册的函数存储起來，到 exitO 时将链表遍历一遍，执行其中所有的回调函数.Windows 版的 atexit 的确可以按照这个思路 实现。

### 4、如何使用 Mini CRT++

这个函数是用于处理共享库的全局对象构造与析构的。我们知道共享库也可以拥有全 局对象 ，这些对象在共享库被装载和卸载时必须被正确地构造和析构。而共享库有可 能在进程退出之前被卸载，比如使用 dlopen dlclose 就可能导致这种情况。那么 个 问题就产生了，如何使得厲子某个共享库的全局对象析构函数在共享库被卸载时运行 呢?GCC 的做法是向 cxa atexit 传递一个参数，这个参数用于标示这个析构函数属 于哪个共享对象。我们在前面实现 时忽略了第三个参数，实际上这第三 个参数就是用子标示共享对象的 它就是 _dso_handle 这个符号。由子在 Mini CRT++ 中并不考虑对共享库的支持，于是我们就仅仅定义这个符号为 0, 以防止链接时出现 符号未定义错误。