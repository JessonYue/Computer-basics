#### 5、优化程序性能

- 编写高效的程序

  	1. 必须选择适当的算法和数据结构
   	2. 必须编写编译器能够有效优化以转换成高效可执行代码的源代码

- 程序优化的第一步就是消除不必要的工作，让代码尽可能有效的执行所期望的任务。包括消除不必要的函数调用、条件测试、内存引用

- 程序优化的第二步是利用处理器提供的指令级并行能力，同时执行多条指令

- 5.1、优化编译器的局限性：只使用安全的优化、函数调用

- 5.2、引入每元素的周期数（CPE）度量标准，作为一种表示程序性能并指导我们改进代码的方法

- 5.4、消除循环的低效率：

  	1. 代码移动：识别要执行多次但计算结果不易改变的计算

- 5.5、减少过程调用

- 5.6、消除不必要的内存引用

- 5.7、理解现代处理器：采用复杂而奇异的微处理器结构，其中，多条指令可以并行执行，同时又呈现一种简单的顺序执行指令的表象

  	1. 延迟界限能够限制程序性能，吞吐量界限刻画了处理器功能单元的原始计算能力，是程序性能的终极限制
   	2. 乱序处理器：指令控制单元（ICU）和执行单元（EU）
   	3. 每个运算都是有延迟：表示完成运算所需的总时间、发射时间“表示两个连续的同类型的运算之间需要的最小时钟周期数、容量：表示能够执行该运算的功能单元的数量
   	4. 处理器操作的抽象模型 ---- 数据流图：是一种图形化的表示方式，展现不同的操作之间的数据相关是如何限制它们的执行顺序的，这些限制形成了图中的关键路径

- 5.8、循环展开：是一种程序变换，通过增加每次迭代计算的元素的数量，减少循环的迭代次数

- 5.9、提高并行性

  	1. 多个累积变量
   	2. 重新结合变换

- 5.11、限制因素

  	1. 寄存器溢出
   	2. 分支预测和预测错误处罚
       	- 不要过分关心壳预测的分支
       	- 书写适合用条件传送实现的代码

- 5.12、内存性能 - 加载（从内存读取到寄存器）、存储（从寄存器写到内存）

  	1. 加载操作的程序的性能：既依赖于流水线的能力，也依赖于加载单元的延迟
   	2. 存储的性能

- 5.13、优化程序性能的基本策略：

  	1. 高级设计
   	2. 基本编码原则
       - 消除连续的函数调用
       - 消除不必要的内存引用
  	3. 低级优化
      - 展开循环，降低开销，并且是的进一步的优化成为可能
      - 通过使用例如多个累积变量和重新结合等技术，找到方法提高指令级并行
      - 用功能性的风格重写条件操作，使得边缘采用条件数据传送

- 系统优化的通用原则，称为Amdahl定律

- 5.14、程序剖析 - GPROF 步骤

  		1. 程序必须为剖析而编译和链接 -- linux> gcc -0g -pg prog.c -o  prog
    		2. 程序像往常一样执行 --- linux> ./prog file.txt
    		3. 调用GPROF来分析gmon.out中的数据 --- linux> prof prog

- GPROF需要注意的属性

  	1. 计时不是很准确
   	2. 假设没有执行内联替换，则调用信息相当可靠
   	3. 默认情况下，不会显示对库函数的计时

- 总结：

  ​		优化程序性能中，程序设计的这些方面应该是程序员主要关心的。良好的编程习惯可以消除不必要的工作，如内存别名使用和过程调用。研究一系列的优化技术，包括循环展开，创建多个累积变量和重新结合，它们可以利用现代处理器提高功能的指令级并行，提高程序的性能

