#### 虚拟内存

- 虚拟内存是一种对主存的抽象概念，为每个进程提供一个大的、一致的和私有的地址空间
- 虚拟内存三个重要的能力
  	1. 将主存看成存储在磁盘上的地址空间的高速缓存，在主存中只保留活动区域，并根据需要在磁盘和主存之间来回拆地数据
   	2. 为每个进程提供一致的地址空间，简化内存管理
   	3. 保护每个进程的地址空间不被其他进程破坏
- 需要理解虚拟内存的原因：
  	1. 虚拟内存是核心的，遍及计算机系统的所有层面
   	2. 虚拟内存是强大的，可以创建和销毁内存片，将内存片映射到磁盘文件的某个部分，以及与其他进程共享内存
   	3. 虚拟内存是危险的，动态分配程序是，会与虚拟内存发生交互
- 9.1、物理和虚拟寻址：将一个虚拟地址转换为物理地址的任务叫做地址翻译
- 9.2、地址空间：是一个非负整数地址的有序集合；如果地址空间的整数是连续的，则说明是一个线性地址空间
- 9.3、虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组，每个字节都有唯一的虚拟地址，作为到数组的索引；VM系统通过将虚拟内存分割为称为虚拟页的大小固定的块来处理磁盘和主存的数据传输
- 在任意时刻，虚拟页的集合分为三个不相交的子集：
  	1. 未分配的：VM系统还未分配的页，不占任何磁盘空间
   	2. 已缓存的：当前已缓存在屋里内存中的已分配页
   	3. 未缓存的：未缓存在物理内存中的已分配页
- 9.3.1、DRAM缓存的组织结构：完全由巨大的不命中开销驱动的
- 9.3.2、页表：存放在物理内存中的数据结构，可以将虚拟页映射到物理页
- 9.3.3、页命中
- 9.3.4、缺页：DRAM缓存不命中称为缺页
- 虚拟内存的习惯说法：块被称为页；在磁盘和内存之间传送页的活动叫交换或者页面调度；页从磁盘换入DRAM（页面调入）或者从DRAM换出磁盘（页面调出）；一直等待，直到最后时刻，也就是当有不命中发生时，才换入页面的这种策略称为按需页面调度
- 9.3.5、分配页面
- 9.3.6、局部性：保证在任意时刻，程序将趋向于在一个较小的活动页面集合上工作，着集合叫左工作集或者常驻集合
- 9.4、操作系统未每个进程提供了一个独立的页表，也就是一个独立的虚拟地址空间
- 按需页面调度和独立的虚拟地址空间的结合，对系统中内存的使用和管理造成了深远的影响。VM简化了链接和加载、代码和数据共享，以及应用程序的内存分配
- 将一组连续的虚拟页映射到任意一个文件中的任意位置的表示法称为内存映射
- 9.5、虚拟内存作为内存保护的工具：通过在页表条目中（PTE）额外添加许可位来控制对一个虚拟页面内容的访问
- 9.6、地址翻译（MMU）：是一个N元素的虚拟地址空间中元素和一个M元素的物理空间中元素之间的映射
- 9.8、内存映射：将一个虚拟内存区域与一个磁盘上的对象关联起来，以初始化这个虚拟捏成区域的内容的过程
- 虚拟捏成区域可以映射到两种类型的对象中：
  	1. Linux文件系统的普通文件
   	2. 匿名文件
- 9.8.1、共享对象：一个对象可以被映射到虚拟内存的一个区域，要么作为共享对象，要么作为私有对象
- 一个映射到共享对象的虚拟内存区域叫做共享区域。类似的，也有私有区域
- 私有对象使用一种叫做写时复制的巧妙技术被映射到虚拟内存中
- 9.8.2、fork函数
- 9.8.3、execve函数
- 9.8.4、使用mmap函数的用户级内存映射：使用mmap函数来创建新的虚拟内存区域，并将对象映射到这些区域中；参数prot包含秒速新映射的虚拟内存区域的访问权限位；参数flags描述被映射对象类型的位组成；使用munmap函数来删除虚拟内存区域
- 9.9、动态内存分配：运行时申请额外的虚拟内存
- 动态内存分配器维护着一个进程的虚拟内存区域称为堆
- 分配器有两种基本风格，都要求应用显示地分配块，不同之处在于由哪个实体来负责释放已分配的块
  	1. 显式分配器：显式地释放任何已分配的块
   	2. 隐式分配器（垃圾收集器）：要求分配器检测一个已分配的块何时不再被程序所使用，那么就释放这个块。自动释放未使用的已分配的块的过程叫垃圾收集
- 9.9.1、malloc和free函数用于动态从堆中分配块，释放块
- 9.9.2、程序使用动态内存分配的最重要原因：经常直到程序实际运行时，才知道某些数据结构的大小
- 9.9.3、显式分配器的要求：
  	1. 处理任意请求序列
   	2. 立即响应请求
   	3. 对齐块
   	4. 不修改已分配的块
- 显式分配器的目标：
  	1. 最大化吞吐率
   	2. 最大化内存利用率
- 一个系统中被所有进程分配的虚拟内存的全部数量受磁盘上交换空间的数量限制
- 9.9.4、造成堆利用率很低的主要原因：一种被称为碎片的现象，当虽然有未使用的内存但不能用来满足分配请求时，就发生这种现象
  	1. 内部碎片
   	2. 外部碎片
- 9.9.5、分配器平衡吞吐率和利用率需要考虑的问题
  	1. 空闲块组织：隐式空闲链表
   	2. 放置：放置策略：1、首次适配；2、下次适配；3、最佳适配
   	3. 分割
   	4. 合并：立即合并、推迟合并  --- 边界标记的合并
- 9.9.12、分配器的实现
  	1. 通用分配器设计
   	2. 操作空闲链表的基本常数和宏
   	3. 创建初始空闲链表
   	4. 释放和合并块
   	5. 分配块
- 9.9.13、显式空闲链表（双向链表）排序策略
  	1. 后进先出（LIFO）的顺序维护链表
   	2. 按照地址顺序来维护链表
- 9.9.14、分离的空闲链表：主要区别在于它们如何定义大小类，何时进行合并，何时向操作系统请求额外的堆内存，是否允许分割
  	1. 简单分离存储
   	2. 分离适配
- 9.10、垃圾收集（隐式动态内存分配器）：垃圾收集器是一种动态内存分配器，它自动释放程序不再需要的已分配块。这些块被称为垃圾。自动回收堆存储的过程叫垃圾收集
- 垃圾收集器将内存视为一张有向可达图，在任何时刻，不可达的节点对应于垃圾
- Mark&Sweep垃圾收集器：由标记阶段和清除阶段组成，标记阶段标记出根节点所有可达的和已分配的后继，而后面的清除阶段释放每个未被标记的已分配的块
- 9.11、C程序常见的与内存有关的错误
  	1. 间接引用坏指针
   	2. 读未初始化的内存
   	3. 允许栈缓冲区溢出
   	4. 假设指针和它们指向的对象是相同大小的
   	5. 造成错位错误
   	6. 引用指针，而不是它所指向的对象
   	7. 误解指针运算
   	8. 引用不存在的变量
   	9. 引用空闲堆中的数据
   	10. 引用内存泄露



#### 总结

1、虚拟内存的概念，虚拟内存的理解

2、主存与虚拟内存的联系，以及虚拟内存如何使用主存

3、虚拟内存如何实现缓存和内存管理

4、虚拟内存提供的三大重要功能

5、虚拟内存如何磁盘相关联

6、理解动态内存分配，动态分配器分为两种类型

7、理解常见的和内存相关的错误

