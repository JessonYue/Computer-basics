#### Linux共享库的组织

- 从文件的结构上来讲，共享库和共享对象没什么区别

 - 8.1、共享库兼容性
   		- 共享库的更新分为：1、兼容更新； 2、不兼容更新
   		- 导致C语言的共享库ABI（接口）改变的行为有：1、导出函数的行为发生改变，也就是调用该函数产生的结果和以前不一致；2、导出函数倍删除；3、导出数据的结构发生变化；4、导出函数的接口发生变化；
   		- 解决共享库的兼容性问题的有效办法之一是使用共享库版本的方法。文件名规则：libname.so.x.y.z
   		- x：主版本号    库的重大升级，不同主版本号之间不兼容
   		-  y：次版本号       库的增量升级，主版本号相同，高的次版本号的库向后兼容低的次版本号
   		-  z：发布版本号   错误修正，性能改进，相同主版本号、次版本号的共享库，不同的发布版本号之间相互完全兼容
   		- 采用SO-NAME的命名机制来记录共享库的依赖关系。每个共享库都有对应的“SO-NAME“，即共享库的文件名去掉次版本号和发布版本号，保留主版本号
   		- 在Linux系统中，系统会为每个共享库在它所在的目录创建一个跟”SO-NAME“相同的并且指向它的软链接
   		- SO-NAME表示一个库的接口，接口不向后兼容，SO-NAME就发生变化
 - 8.2、符号版本
   - 次版本交会问题：低次版本号不兼容高次版本号，高次版本号兼容低次版本号  --- 解决方式：符号版本机制
   - 基于符号的版本机制方案的基本思路：让每个导入和导出的符号都有一个相关联的版本号，它的实际做法类似于名称修饰的方法
   - 链接器在链接时根据符号版本脚本中指定的关系来产生共享库，并且设置符号的集合与它们之间的关系
- 8.3、共享库系统路径
  - FHS(File Hierarchy Standard)标准规定一个系统的系统文件应该如何存放，包括各个目录的结构、组织和作用，这有利于促进各个开源操作系统之间的兼容性
  - FHS规定，系统中存放共享库的主要位置：
    	1. /lib 存放系统最关键和基础的共享库
     	2. /usr/lib 保存一些非系统运行时所需要的关键性的共享库
     	3. /usr/local/lib 存放一些和操作系统本身并不十分相关的库
- 8.4、共享库查找过程
  	- 动态链接器对于模块的查找规则：如果“.dynamic”的DT_NEED里面保存的事绝对路口，那动态链接器就按照路径查找；如果DT_NEED里面保存的是相对路径，那么动态链接器会在/lib、/usr/lib和由/etc/Id.so.conf配置文件指定的目录中查找共享库。为了程序的可移植性和兼容性，共享库的路径往往是相对的
  	- Id.so.conf是一个文本配置文件，指定的目录有：1、/uer/local/lib ； 2、/lib/i486-linux-gnu； 3、/usr/lib/i486-linux-gnu
  	- Linux系统都有一个Idconfig程序，作用是为共享库目录下的各个共享库创建、删除和更新相应的SO-NAME，并且讲这些SO-NAME收集起来，集中存放到/etc/Id.so.cache文件里面，建立一个SO-NAME缓存，加快共享库的查找过程
  	- 如果动态链接器在/etc/Id.so.cache里面没有找到所需要的共享库，那么还会遍历/lib和/usr/lib这两个目录，如果还没有宣告失败
- 8.5、环境变量
  - LD_LIBRARY_PATH：可以临时改变某个应用程序的共享库查找路径，而不会影响系统中的其他程序
  - 动态链接器会按照下列顺序依次装载或者查找共享对象：
    - 由环境变量LD_LIBRARY_PATH指定的路径
    - 由路径缓存文件/etc/Id.so.cache指定的路径
    - 默认共享库目录，先/usr/lib，后/lib
  - LD_PRELOAD：指定预先装载的一些共享库或者目标文件（比LD_LIBRARY_PATH优先，无论是否依赖，都会装载）
  - LD_DEBUG：可以打开动态链接器的调试功能
- 8.6、共享库的创建和安装
  - 共享库的创建，和共享对象的创建过程基本一致
    - 最关键的使用GCC的两个参数：“-shared”和“-fPIC”
    - “-shared”表示输出结果是共享库类型
    - “-fPIC”表示使用地址无关代码技术来生产输出文件
    - “-Wl, -soname, my_soname”将指定参数传递给链接器
  - 清除符号信息：strip：清除共享库或者可执行文件的所有符号和调试信息
  - 共享库安装：
    - 将共享库复制到某个标准的共享库目录，如/lib、/usr/lib等，然后运行Idconfig即可，需要系统root权限
    - 建立相应的SO_NAME软链接，并告诉编译器和程序如何查找该共享库
      1. 建立软链接，Idconfig -n  shared_library-directory
      2. 编译程序时，指定共享库的位置，“-L”:指定共享库搜索目录；“-l”:指定共享库路径
  - 共享库构造和析构函数
    - 在函数声明时加上“ \__ailribute__ ((constructor))”的属性，指定该函数为共享库构造函数
    - 在函数声明时加上“ \__ailribute__ ((destructor))”的属性，指定该函数为共享库析构函数
    - 多个构造函数，默认情况下执行顺序没有规定，需要可以使用优先级参数定义
  - 共享库脚本：共享库普遍时动态链接的ELF共享对象文件（.so）,事实上，共享库还可以是符号一定格式的链接脚本文件
- 系统存在大量的共享库，随着更新和升级形成不同的相互兼容和不兼容的版本。如何管理和维护这些共享库，让它们不同的版本之间不会相互冲突时使用共享库的一个重要问题

