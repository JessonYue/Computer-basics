# 第三章

## 程序编码

在程序运行过程中，计算机系统实现了多种的抽象方式一方面便于人们阅读，另一方面隐藏实现细节。这其中有位重要是两种抽象：

- 指令集体系结构（指令集架构），这定义了
- 利用虚拟地址将多个硬件储存器和软件结合起来

下面是C代码在Linux中执行的大概流程

`gcc -0g -o p p1.c p2.c`

1. 扩展源代码，插入所有用`#include`指定的文件，扩展所有用#`define`指定的宏
2. 编译器生成两个源文件的汇编代码p1.s和p2.s
3. 汇编器将汇编代码转化成二进制目标代码p1.o和p2.o
4. 连接器将两个目标代码文件与实现函数库代码合并

## 访问信息

随着CPU技术的发展，CPU中包含寄存器的数量也越来越多，每个寄存器也从32位拓展成64位。同时，每个寄存器也有其不同的作用。

大多数指令有一个或者多个操作数，用来指示出执行一个操作中要是用的源数据值，以及防止结果的目的位置

这种操作数分三种：

- 立即数，用来表示常数值
- 寄存器，用来表示某个寄存器的内容
- 内存引用，根据有效地址访问内存位置（指针？）

操作数的通用性是的一条简单的数据传送指令能够完成在许多机器中要好几条不同指令才能完成的功能

栈是一种遵循后进先出原则的数据结构，即弹出的值用元是最近被亚茹而且仍在栈中的值。

## 算数和逻辑操作

x86-64中大多数操作都分成了指令类，这些指令类有各种带不同大小操作数的变种。每条指定类都有四种指令：

- 加载有效地址
- 一元操作
- 二源操作
- 移位

加载有效地址的指令形式是从内存读取数据到寄存器，它将有效的地址写到目的的操作数。

一元操作，是只有一个操作数，既是源又是目的。这个操作数可以是一个寄存器，也可以是一个内存位置。例如C语言中的（++）（--）

二源操作，操作数是第一个，目的操作数是第二个。这里第二个操作数既是源又是目的。例如，C语言中的（x-=y）

移位操作，先给出移位量，然后给出的是要移位的数。

## 控制

除了整数寄存器，CPU还维护着一组单个位的条件码寄存器用来描述最近的算数或逻辑操作的属性。条件码通常不会直接读取，常用的是费用方法有三种：

- 可以根据条件码的某种组合，将一个字节设为0或1。（if）
- 可以条件跳转到程序的某个其他部分。正常执行的情况下，指令按照他们出现的顺序一条一条地执行。跳转指令可以导致执行程序切换到程序中一个全新的位置。（continue，break）
- 可以有条件地传送数据

## 过程

过程提供了一种封装代码的方式，即用一组指定的参数和一个可选的返回值实现了某种功能。过程的形式多样，例如函数，方法，子例程，处理函数，等等。

一个过程从被调用，到返回值包括如下机制：

- 传递控制
- 传递数据
- 分配和释放内存

运行时栈

大多数语言在调用过程中使用栈提供的后进先出的管理原则。这种原则的优点是

- 当当前过程执行时，其他调用链的过程都会被挂起
- 当当前过程返回时，在该过程中分配的局部储存空间会被释放

转移控制

将控制从函数A转移到函数B，方法是吧程序计数器（PC）设置为B的代码的起始位置。这个感觉就是从一个函数（方法）调用到另一个函数（方法）

数据传送

过程调用还可能把数据作为参数传递，而从过程返回还有可能包括返回一个值。在x86-64中，大部分过程见的数据传送是通过寄存器实现的。

栈上的局部储存

有些时候，一些局部数据必须放在内存中，常见的情况包括：

- 寄存器不足够存放所有的本地数据。
- 对一个局部变量使用地址运算符`&`,因此必须能够为它产生一个地址。
- 某些局部变量是数组或结构，因此必须能够通过数组或者结构引用被访问到。

寄存器中的局部存储空间

寄存器是唯一被所有过程共享的资源（是否意味着不安全？）。根据惯例，寄存器%rbx、%rbp、%r12~%r15被划分为调用者保存寄存器。即，当过程被调用时，过程必须保存这些值，并且保证这些值在调用和返回时是一样的。

## 数组分配和访问

C语言中，数组是一种将标量数据聚集成更大数据类型的方式。

指针运算

C语言中的指针可以进行运算，其运算出来的值就是会根据该指针引用的数据类型的大小进行伸缩。即

如果说P是一个指向类型为T放入数据的指针，且P的值为x。那么：
$$
p+i = x+L*i
$$
这里L是数据类型T的大小。

单操作数操作符`&`和`*`可以产生指针和间接应用指针：

`&`：对于一个表达式Expr, &Expr是给出该对象地址的一个指针，这里获取的是一个指针

`*`：对于一个表示地址的表达式AExpr，*AExp是给出该地址处的值，这里获取的是一个值

## 异质的数据结构

结构

用关键字struck来声明，将多个可能不同类型的对象集合到一个单位中

联合

用关键字（union）来声明，允许几种不同的类型来引用一个对象。

## 在机器级程序中将控制于数据结合起来

- C中的指针映射到机器代码的关键原则：
- 每个指针都对应一个类型。
- 每个指针都有一个值
- 指针用`&`创建
- `*`操作符用于间接引用指针。其结果是一个值，它的类型和该指针的类型一致。
- 数组与指针紧密联系
- 将指针强转，只改变类型不改变值。
- 指针也可以指向函数。

缓冲区溢出

在栈中分配某个字符数组来保存一个字符串，但是字符串的长度超出了数组分配的空间。

为了对抗缓冲区溢出攻击，Linux提供了如下机制：

栈随机化，即栈的位置在程序每次运行时都有变化

栈破环检测，利用一个存储在栈帧中任何局部缓冲区与栈之间的值来进行检测

限制可执行代码区域，即消除攻击者向系统插入可执行代码的能力。











