# 第七章 链接

链接是将各种代码和数据片段手机并组合成为一个单一文件的过程，这个文件可以被加载（复制）到内存中执行。

**静态链接**

链接可以在编译时由静态编译器完成，为了构造可执行文件，链接器必须完成两个主要任务：

- 符号解析
- 重定位

**目标文件**

目标文件纯粹是字节块的集合，包含程序代码，程序数据。有三种形式：

- 可重定位目标文件
- 可执行目标文件
- 共享目标文件

**可重定位目标文件**

ELF格式的文件，即可重定位目标文件，包含如下内容：

- .text：已编译程序的机器代码
- .rodata：只读数据，比如prinf语句中的格式串和开关语句的跳转表
- .data：已初始化的全局和静态C变量。局部C变量在运行时被保存在栈中，即不出现在.data节中，也不出现在.bss节中
- .bss：未初始化的全局和静态C变量，以及所有被初始化为0的全局或静态变量
- .symtab：一个符号表，它存放在程序中定义和引用的函数和全局变量的信息。
- .rel.text：一个.text节中位置的列表，当链接器把这个目标文件和其他文件组合时，需要修改这些位置。
- .rel.data：被模块引用或定义的所有全局变量的重定位信息。
- .debug：一个调试符号表，其条目是程序中定义的局部变量和类型定义，程序中定义和引用的全局变量，以及原始的C源文件。
- .line：原始C源程序中的行号和.text节中机器指令之间的映射。
- .strtab：一个字符串表，内容包括.symtab和.debug节中的符号表，以及节头部中的节名字。

**符号和符号表**

每个可重定位目标模块m都有一个符号表，它包含m定义和引用的符号的信息。共有三种不同的符号

- 由模块M定义并能被其他模块引用的全局符号。全局链接器符号对应于非静态的C函数和全局变量
- 由其他模块定义并被模块M引用的全局符号。这些符号称为外部符号，对应于在其他模块中定义的非静态C函数和全局变量
- 制备模块M定义和引用的局部符号。对应于带static属性的C函数和全局变量。这些符号在模块M中随处可见，但是不能被其他模块引用

**符号解析**

链接器解析符号引用的方法是将每个引用与它输入的可重定位目标文件的符号表中的一个确定的符号定义关联起来。

**重定位**

重定位包含两步：

- 重定位节和符号定义
- 重定位节中的符号引用

**共享库**

是一个目标模块，在运行或者加载时，可以加载到任意的内存地址，并和一个在内存中的程序链接起来

**库打桩机制**

库打桩机制即允许截获对共享库函数的调用，取而代之执行自己的代码。共分以下几种方式：

- 编译时打桩
- 链接时打桩
- 运行时打桩

