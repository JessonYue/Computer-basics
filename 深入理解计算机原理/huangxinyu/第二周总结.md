### 主存与cache的地址映射

cache的容量很小，它保存的内容只是主存内容的一个子集，且cache与主存的数据交换是已块位单位。

问题：指令对存储器进行读写时，指令中的地址是内存系统中的存储器地址还是cache地址？

**地址映射**即是应用某种方法把主存地址定位到cache中。

当CPU访问存储器时，它所给的一个字的内存地址会自动变成cache的地址。

地址映射方式有`全相联`,`直接`,`组相联`三种方式。

- **全相联**，主存的一个块直接拷贝到cache中的任意一行上，非常灵活。 优点：冲突概率小，Cache的利用率高。 缺点：每次cpu要访问主存中的一个字地址时要比较cache中的所有行，才能知道在不在cache中，而硬件的比较器设计比较困难。
- **直接映射**，主存拷贝到cache时将cache的行数模主存的块号，得到了cache的行号。 优点：cpu访问内存地址时能立马知道在不在cache中。 缺点：容易冲突。
- **组相联**，组相联实际上对以上两种方式的折中实现。

#### 替换策略

映射冲突时的替换策略？

最近最少使用。

#### cache的写操作策略

**1. 写回法（write back，回写法）**

当CPU写cache命中时，只修改cache的内容，而不立即写入主存；只有当此行（块）被换出时才写回主存。

这种方法减少了访问主存的次数，但是存在不同步的隐患。

**2. 全写法（write through)**

当CPU 写命中cache时，cache与主存同事发生写修改。
这种方式维护了cache与主存的内容的一致性，但是降低了cache的功效。

### 虚拟存储器

虚拟存储器的一个重要用途是解决计算机中住存储器的容量问题，在不明显降低平均访问速度的前提下增加程序的访问空间。

- **虚拟地址（逻辑地址）**：程序指令生成的地址。
- **物理地址（实际地址）**：程序指令生成的地址经过转换后的地址。
- **虚地址空间**：虚拟地址的范围，它是程序员所看到的地址空间。
- **实地址空间**：实际主存地址的范围。

虚拟地址访问过程：

1. 由cpu送虚拟地址，通过查询表看虚拟地址对应的单元内容是否装入主存。
2. 如果在主存，把虚拟地址变换为主存地址（物理地址）后，对主存相应单元进行访问。
3. 如果不在主存，将虚拟地址对应的内容调入主存中，然后进行访问。

cache-主存和主存-辅存的主要区别：

1. **数据通路不同**，cpu与cache和主存之间有直接访问通路，cache不命中时可以直接访问主存；而虚存所依赖的辅存与cpu之间不存在直接的数据通路，当主存不命中时只能通过调页解决，cpu最终还是要访问主存。
2. **地址映射不同**，虚拟存储器一般使用的`全相联`地址映射方式以提高命中率。主存与磁盘等外设的工作速度差异很大，因此对于虚拟存储器提高命中率特别重要。
3. **虚拟存储器的存储空间大小受到计算机地址空间的限制**，即虚拟地址的位数，而cache存储器容量以及主存的容量则一般远小于cpu的地址空间，因此不存在限制。
4. 虚拟存储器主要由软件进行管理，而cache由硬件管理的。

#### 主存-外存层次的基本信息传送单元

主存-外存层次的基本信息传送单元可采用几种不同的方案：**段**、**页**或**段页**。

**段式管理**：是按照程序的逻辑结构划分成多个相对独立的部分，作为独立的逻辑单位。

优点：段的逻辑独立性使它易于编译、管理、修改和保护，也便于多道程序共享；
缺点：段的长度各不相同，给主存控件分配带来麻烦，而且容易在段间留下许多空余的零碎存储空间，造成浪费。

**页式管理**：主存物理空间划分出来的等长的固定区域。

优点：页面的的大小是固定的，方便造页表，比段式空间浪费小。

缺点：处理、保护和共享都不及段式方便。

**段页式管理**：采用段式和页式结合的方法。

程序按模块分段，段内再分页，进入主存以页为基本信息传送单位，用段表和页表进行两级定位管理。

段页式管理逻辑地址 = 基号+段号+页号+页内地址
基号标明是哪个程序。

### 指令系统

#### 指令格式

指令：操作码字段 地址码字段

地址码字段：寻址特征 形式地址

#### 指令和数据的寻址方式

寻址方式分为两类：`指令寻址`,`数据寻址`

- 指令寻址：确定下一条欲执行指令的指令地址
- 数据寻址：确定本条指令的操作数地址

指令寻址有顺序寻址（PC+1）,跳跃寻址(PC+n)，跳跃寻址一般是遇到JMP指令。

数据寻址有：

1. 立即数寻址，形式地址中的数字就是操作码本身
2. 直接寻址，形式地址就是操作数的有效地址，1次访存
3. 间接寻址，形式地址是操作数的有效地址的地址，间接寻址是为了扩大寻址范围，因为形式地址的长度比较短，需要2次访存
4. 寄存器寻址，有效地址是寄存器的编号，不访问内存，速度快
5. 寄存器间接寻址，有效地址在寄存器中，1次访存
6. 隐含寻址，如ADD指令，正常是要两个操作数的，但是有一个操作是默认的在ACC寄存器中。
7. 相对寻址，EA = A+(PC)，相对于程序当前运行位置的相对偏移地址，A的位数决定了操作数的寻址范围，广泛用于转移指令。
8. 基址寻址，EA = A+(BR)，BR为基址寄存器，可扩大寻址范围。
9. 变址寻址，EA = A+(IX)，IX为变址寄存器，通用寄存器也可以作为变址寄存器。
10. 段寻址，扩大寻址范围。

### 中央处理器（CPU）

#### 寄存器

**数据缓冲寄存器（DR）。**

1. 作为CPU和内存、外部设备之间信息传递的中转站；
2. 补偿CPU和内存、外部设备之间在操作速度上的差别；

**指令寄存器（IR）**

指令寄存器用来保存当前正在执行的一条指令。

**程序计数器（PC）**

程序计数器也叫指令计数器，总是指向下一条指令的地址。

**地址寄存器（AR）**

地址寄存器用来保存当前CPU所访问的内存单元的地址。

**通用寄存器（R）**

当运算器的算术逻辑单元（ALU）执行算术或逻辑运算时，为ALU提供一个工作区。

**状态条件寄存器（PSW）**

状态条件寄存器保存由算术指令和逻辑指令运行或测试的结果建立的各种条件码内容，如进位标志（C），溢出标志（V），零标志（Z），负标志（N）等等。

#### 指令执行过程

##### 指令周期的基本概念

问题：计算机读取的指令和数据都是存储器中的二进制数据，计算机如何区分这二进制是指令还是数据？

根据时间来区分，取指令周期从内存中取出的是指令，执行周期从内存中取出的是数据。

- **指令周期**，CPU从内存中取出一条指令并执行这条指令的时间总和。不同指令的指令周期不同。
- **CPU周期**，又称机器周期，用从内存读取一条指令字的最短时间来定义。
- **时钟周期**，通常称为节拍脉冲周期或T周期。一个CPU周期包含若干个时钟周期。

![CPU指令](https://upload-images.jianshu.io/upload_images/1360972-73ca25c204eb9ee1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&ynotemdtimestamp=1592180085584)

以 ADD 30为例的cpu执行过程（不同cpu模型有些不同）：

取指令周期：

1. 程序计数器内容写入地址寄存器，程序计数器+1；
2. 通过地址总线从内存中取出地址寄存器对应地址的指令；
3. 将指令先送到缓冲寄存器；
4. 将指令送到指令寄存器，然后指令译码器，操作控制器时序成生气产生指令周期时钟脉冲；

执行周期：

1. 将 ADD 30中的操作数传给地址寄存器；
2. 通过地址总线从内存中取出地址寄存器对应地址的数据；
3. 将数据传给缓存寄存器；
4. 缓存寄存器将数据传给ALU；
5. ALU将计算结果存到累加器中。

问题：为什么一个CPU周期要有4个时钟周期？

一个CPU周期所做的动作4个步骤可以完成。

#### 微程序控制器

##### 微命令和微操做

- **微命令**：控制部件通过控制线向执行部件发出的各种控制指令。
- **微操做**：执行部件接受微命令后进行的操作。
- **相容性**微操做：同时或在同一个CPU周期内可以并行执行的微操做。
- **互斥性**微操做：不能同时或不能在同一个CPU周期内以并行执行的微操做。

##### 微指令和微程序

- **微指令**：在机器的一个CPU周期中，一组实现一定操作功能微命令的组合。
- **微程序**：实现一条机器指令功能的多条微指令组成的序列。

### 流水CPU

#### 并行处理技术

并行性的两种含义：

1. 同时性：指两个以上事件在同一时刻发生；
2. 并发性：指两个以上事件在同一时刻间隔内发生。