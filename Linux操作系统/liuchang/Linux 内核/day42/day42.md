## 									第四章 中断和异常

中断（interrupt）通常被定义为一个时间，该事件改编处理器执行的指令顺序。

中断通常分为同步（synchronous）中断 和异步（asynchronous）中断：

1、同步中断是当指令执行时由 CPU 控制单元产生的，之所以称为同步，是因为只有在一条指令终止执行后 CPU 才会发出中断。

2、异步中断是由其他硬件设别依照 CPU 时钟信号随机产生的。

中断是由间隔定时器和 I/O 设备产生的。异常是由程序的错误产生的，或者是由内核必须处理的异常条件产生的。

### 中断信号的作用

当一个中断信号达到时，CPU 必须停止它当前正在做的事情，并且切换到一个新的活动。为了做到这一点，就要在内核态堆栈保存程序计算器的当前值，并把雨中断类型相关的一个地址放进程序计数器。

中断处理是由内核执行的最敏感任务之一，但是它必须满足约束：

1、当内核正打算去完成一些别的事情时，中断随时会到来。因此，内核的目标就是让中断尽可能快地处理完，尽其所能把更多的处理向后推迟。

2、因为中断随时会到来，所以内核可能正在处理其中的一个中断时，另一个中断又发生了。应该尽可能多地允许这种情况的发生，因为这能维持更多的 I/O 设备处于忙状态。

3、尽管内核在处理前一个中断时可以接受一个新的中断，但在内核代码中还是存在一些临界区，在临界区中，中断必须被禁止。

### 中断和异常

中断：要根据中断允许标志的设置来判断 CPU 是否能响应中断请求

可屏蔽中断：I/O 设备发出的所有专断请求都产生可屏蔽中断。

非屏蔽中断：只有几个危急事件才引起非屏蔽中断。非屏蔽中断总是由 CPU 辨认。

异常：

处理器探测异常：当 CPU 执行指令时探测到的一个翻唱条件所产生的异常。

故障：通常可以纠正；一旦纠正，程序就可以在不失连贯性的情况下重新开始。保存在 eip 中的值时引起故障的指令地址，因此，当异常处理程序终止时，那条指令会被重新执行。

陷阱：在陷阱指令执行后立即报告；内核把控制权返回给程序后就可以继续它的执行而不失连贯性。保存在 eip 中的值是一个随后要执行的指令地址。

异常中止：发生一个严重的错误；控制单元出了问题，不能在 eip 寄存器中保存引起异常的指令所在的确切位置。

编程异常：在编程者发出请求时发生。是由 int 或 int3 指令触发的；当 into 和 bound 指令检查的条件不为真时，也引起编程异常。

### IRQ 和中断

每个能够发出中断请求的硬件设备控制器都有一条名为 IRQ 的输出线。所有现有的 IRQ 线都与一个名为可编程中断控制器的硬件电路的输入引脚相连。

可编译中断控制器执行下列动作：

1、监视 IRQ 线，检查产生的信号。如果有条或两条以上的 IRQ 线上产生信号，就选择引脚变好较小的 IRQ 线。

2、如果一个引发信号出现在 IRQ 线上：

​		a.把接收到的引发信号转化成相应的向量。

​		b.把这个向量存放在中断控制器的一个 I/O 端口，从而允许 CPU 通过数据总线读此向量。

​		c.把引发信号发送到处理器的 INTR 引脚，即产生一个中断。

​		d.等待，直到 CPU 通过把这个中断信号写进可编程中断控制器的一个 I/O 端口来确认它；当这种情况发生时，清 INTR 线。

3、返回到第1步。

### 高级可编程中断控制器

外部硬件设备的中断请求以两种方式在可用 CPU 之间分发：

静态分布：IRQ 信号传递给重定向表相应项中所列出本地 APIC。

动态分布：如果处理器正在执行最优先级的进程，IRQ 信号就传递给这种处理器的本地 APIC。

大部分单处理器系统的包含一个 I/O APIC 芯片，可以用以下两种方式对这种芯片进行配置：

1、作为一种标准 8259A 方式的外部 PIC 连接到 CPU。本地 APIC 被禁止，两条 LINT0 和 LINT1 本地 IRQ 线分别配置为 INTR 和 NMI 引脚。

2、作为一种标准外部 I/O APIC。本地 APIC 被激活，且所有的外部中断都通过 I/O APIC 接收。









